<!DOCTYPE html>
<html lang="en">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="recipes.html" class="active">Recipes</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="login.html">Login</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="search-section">
        <div class="search-container">
                <div class="input-group">
                    <input type="text" id="ingredientInput" placeholder="Enter an ingredient...">
                    <button onclick="addIngredient()" class="add-btn">Add</button>
        </div>
        
        <div class="ingredient-list">
                    <h3>Your Ingredients</h3>
            <ul id="ingredientList"></ul>
        </div>

                <div class="button-group">
                    <button onclick="searchRecipes()" class="btn btn-primary">Get Recipes</button>
                    <button onclick="findOtherRecipes()" class="btn btn-secondary">Find Similar Recipes</button>
                    <button class="btn btn-danger delete-all-button" onclick="deleteAllIngredients()">Clear All</button>
                </div>
            </div>
        </section>

        <section class="results-section">
        <div id="recipeResults">
                <h2>Suggested Recipes</h2>
                <div class="recipes-grid" id="recipesList">
                    <!-- Recipe cards will be dynamically added here -->
                </div>
        </div>
        </section>

        <section class="camera-section">
        <div class="camera-button-container">
                <a href="camera.html" class="camera-link">
                    <button class="btn camera-btn">
                        <span class="camera-icon">ðŸ“·</span>
                        Scan Ingredients
                    </button>
            </a>
        </div>
        </section>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>RecipeFindr</h3>
                <p>Your ultimate recipe discovery platform</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="recipes.html">Recipes</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 RecipeFindr. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        let videoStream;
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const previewImage = document.getElementById('preview');

        let shownRecipeIds = new Set(); // Track which recipes have been shown
        
        // Mock recipe data
        const mockRecipes = [
            {
                id: 1,
                title: "Classic Spaghetti Bolognese",
                image: "https://spoonacular.com/recipeImages/716429-556x370.jpg",
                readyInMinutes: 45,
                difficulty: "Medium",
                ingredients: ["spaghetti", "ground beef", "tomatoes", "onion", "garlic", "olive oil", "parmesan cheese"],
                instructions: "1. Cook spaghetti...",
                nutrition: {
                    calories: 450,
                    protein: "25g",
                    carbs: "60g",
                    fat: "15g"
                },
                tags: ["italian", "pasta", "meat", "dinner"]
            },
            {
                id: 2,
                title: "Vegetable Stir Fry",
                image: "https://spoonacular.com/recipeImages/716430-556x370.jpg",
                readyInMinutes: 30,
                difficulty: "Easy",
                ingredients: ["rice", "mixed vegetables", "soy sauce", "ginger", "garlic", "sesame oil", "bell peppers"],
                instructions: "1. Cook rice...",
                nutrition: {
                    calories: 350,
                    protein: "15g",
                    carbs: "50g",
                    fat: "10g"
                },
                tags: ["asian", "vegetarian", "quick", "healthy"]
            },
            {
                id: 3,
                title: "Chicken Curry",
                image: "https://spoonacular.com/recipeImages/716431-556x370.jpg",
                readyInMinutes: 60,
                difficulty: "Medium",
                ingredients: ["chicken", "curry powder", "coconut milk", "onion", "garlic", "ginger", "turmeric"],
                instructions: "1. Cook chicken...",
                nutrition: {
                    calories: 500,
                    protein: "30g",
                    carbs: "40g",
                    fat: "20g"
                },
                tags: ["indian", "spicy", "meat", "dinner"]
            },
            {
                id: 4,
                title: "Greek Salad",
                image: "https://spoonacular.com/recipeImages/716432-556x370.jpg",
                readyInMinutes: 15,
                difficulty: "Easy",
                ingredients: ["tomatoes", "cucumber", "feta cheese", "olives", "olive oil", "red onion", "oregano"],
                instructions: "1. Chop vegetables...",
                nutrition: {
                    calories: 250,
                    protein: "10g",
                    carbs: "15g",
                    fat: "18g"
                },
                tags: ["mediterranean", "vegetarian", "salad", "healthy"]
            },
            {
                id: 5,
                title: "Beef Stew",
                image: "https://spoonacular.com/recipeImages/716433-556x370.jpg",
                readyInMinutes: 120,
                difficulty: "Hard",
                ingredients: ["beef", "potatoes", "carrots", "onion", "beef broth", "red wine", "thyme"],
                instructions: "1. Brown beef...",
                nutrition: {
                    calories: 600,
                    protein: "35g",
                    carbs: "45g",
                    fat: "25g"
                },
                tags: ["comfort food", "meat", "slow-cooked", "dinner"]
            }
        ];

        // Start the camera stream
        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = videoStream;
            } catch (error) {
                console.error('Error accessing the camera:', error);
            }
        }

        // Capture the image from the video stream
        function takePicture() {
            const context = canvasElement.getContext('2d');
            // Set the canvas size to match the video feed
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            // Draw the current frame from the video on the canvas
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

            // Get the image data as a data URL
            const imageData = canvasElement.toDataURL('image/png');
            previewImage.src = imageData;
            previewImage.style.display = 'block';
        }

        // Function to add an ingredient to the list
        function addIngredient() {
            const input = document.getElementById('ingredientInput');
            const list = document.getElementById('ingredientList');
            const ingredient = input.value.trim();
            
            if (ingredient) {
                const listItem = document.createElement('li');
                listItem.className = 'ingredient-item';

                const ingredientText = document.createElement('span');
                ingredientText.textContent = ingredient;

                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-ingredient-btn';
                deleteButton.innerHTML = 'Ã—';
                deleteButton.onclick = function() {
                    deleteIngredient(listItem);
                };

                listItem.appendChild(ingredientText);
                listItem.appendChild(deleteButton);
                list.appendChild(listItem);
                
                input.value = ''; // Clear input after adding
                input.focus(); // Return focus to input
            }
        }

        // Function to delete an ingredient
        function deleteIngredient(listItem) {
            listItem.remove();
        }

        // Function to delete all ingredients
        function deleteAllIngredients() {
            // Clear the ingredient list
            const list = document.getElementById('ingredientList');
            list.innerHTML = '';
            
            // Also clear any recommended recipes
            const recipesList = document.getElementById('recipesList');
            if (recipesList) {
                recipesList.innerHTML = '<div class="message">Add ingredients to see recipe recommendations</div>';
            }
            
            // Reset the shown recipe IDs set to start fresh
            shownRecipeIds.clear();
        }

        // Function to get ingredients from the list
        function getIngredients() {
            const listItems = document.querySelectorAll('#ingredientList li span');
            return Array.from(listItems).map(item => item.textContent.trim());
        }

        // Function to normalize ingredients for better matching
        function normalizeIngredient(ingredient) {
            return ingredient.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '') // Remove special characters
                .trim();
        }

        // Function to find ingredient matches with fuzzy matching
        function findIngredientMatches(userIngredient, recipeIngredients) {
            const normalizedUserIngredient = normalizeIngredient(userIngredient);
            
            // Exact match
            if (recipeIngredients.some(ing => normalizeIngredient(ing) === normalizedUserIngredient)) {
                return true;
            }

            // Partial match (ingredient contains user input)
            if (recipeIngredients.some(ing => normalizeIngredient(ing).includes(normalizedUserIngredient))) {
                return true;
            }

            // Common ingredient variations
            const variations = {
                'tomato': ['tomatoes', 'cherry tomatoes', 'roma tomatoes'],
                'onion': ['onions', 'red onion', 'yellow onion', 'white onion'],
                'garlic': ['garlic cloves', 'minced garlic'],
                'chicken': ['chicken breast', 'chicken thighs', 'chicken pieces'],
                'beef': ['ground beef', 'beef chunks', 'beef strips'],
                'cheese': ['parmesan', 'cheddar', 'mozzarella', 'feta']
            };

            for (const [base, variants] of Object.entries(variations)) {
                if (normalizedUserIngredient === base && 
                    recipeIngredients.some(ing => variants.includes(normalizeIngredient(ing)))) {
                    return true;
                }
            }

            return false;
        }

        // Function to calculate recipe match score
        function calculateMatchScore(recipe, userIngredients) {
            let score = 0;
            const matchedIngredients = new Set();
            const unmatchedIngredients = new Set();

            // Check each user ingredient against recipe ingredients
            userIngredients.forEach(userIngredient => {
                if (findIngredientMatches(userIngredient, recipe.ingredients)) {
                    score += 2; // Increased base score for matches
                    matchedIngredients.add(userIngredient);
                } else {
                    unmatchedIngredients.add(userIngredient);
                }
            });

            // Calculate match percentage
            const matchPercentage = matchedIngredients.size / userIngredients.length;

            // Bonus points based on match percentage
            if (matchPercentage === 1) {
                score += 10; // Maximum bonus for using all ingredients
            } else if (matchPercentage >= 0.8) {
                score += 5; // High bonus for using most ingredients
            } else if (matchPercentage >= 0.5) {
                score += 2; // Moderate bonus for using half or more ingredients
            }

            // Penalty for unmatched ingredients
            if (unmatchedIngredients.size > 0) {
                score -= unmatchedIngredients.size;
            }

            return {
                score,
                matchedIngredients: Array.from(matchedIngredients),
                unmatchedIngredients: Array.from(unmatchedIngredients),
                matchPercentage
            };
        }

        // Function to search for recipes
        async function searchRecipes() {
            const ingredients = getIngredients();
            if (ingredients.length === 0) {
                displayNoIngredientsMessage();
                return;
            }

            try {
                // Show loading state
                const recipesList = document.getElementById('recipesList');
                recipesList.innerHTML = '<div class="loading">Searching for recipes...</div>';

                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Calculate match scores for all recipes
                const recipesWithScores = mockRecipes.map(recipe => {
                    try {
                        const matchResult = calculateMatchScore(recipe, ingredients);
                        return {
                            ...recipe,
                            matchScore: matchResult.score,
                            matchedIngredients: matchResult.matchedIngredients,
                            unmatchedIngredients: matchResult.unmatchedIngredients,
                            matchPercentage: matchResult.matchPercentage
                        };
                    } catch (error) {
                        console.error('Error calculating match score for recipe:', recipe.title, error);
                        return {
                            ...recipe,
                            matchScore: 0,
                            matchedIngredients: [],
                            unmatchedIngredients: ingredients,
                            matchPercentage: 0
                        };
                    }
                });

                // Filter and sort recipes by match score
                const recipes = recipesWithScores
                    .filter(recipe => recipe.matchPercentage >= 0.5) // Only show recipes that match at least half the ingredients
                    .sort((a, b) => {
                        // First sort by match percentage
                        if (a.matchPercentage !== b.matchPercentage) {
                            return b.matchPercentage - a.matchPercentage;
                        }
                        // Then by match score
                        return b.matchScore - a.matchScore;
                    });
                
                // Reset shown recipes when doing a new search
                shownRecipeIds.clear();
                
                if (recipes.length === 0) {
                    displayNoRecipesMessage();
                } else {
                    // Add recipe IDs to shown set
                    recipes.forEach(recipe => shownRecipeIds.add(recipe.id));
                    displayRecipes(recipes);
                }
            } catch (error) {
                console.error('Error in searchRecipes:', error);
                displayErrorMessage(error);
            }
        }

        // Function to find similar recipes
        async function findOtherRecipes() {
            const ingredients = getIngredients();
            if (ingredients.length === 0) {
                displayNoIngredientsMessage();
                return;
            }

            try {
                // Show loading state
                const recipesList = document.getElementById('recipesList');
                recipesList.innerHTML = '<div class="loading">Finding similar recipes...</div>';

                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Filter out recipes that have already been shown
                const newRecipes = mockRecipes.filter(recipe => !shownRecipeIds.has(recipe.id));
                
                if (newRecipes.length === 0) {
                    // If no new recipes, show a message and reset the shown recipes
                    shownRecipeIds.clear();
                    displayNoMoreRecipesMessage();
                } else {
                    // Add new recipe IDs to shown set
                    newRecipes.forEach(recipe => shownRecipeIds.add(recipe.id));
                    displayRecipes(newRecipes);
                }
            } catch (error) {
                displayErrorMessage(error);
            }
        }

        // Function to display no more recipes message
        function displayNoMoreRecipesMessage() {
            const recipesList = document.getElementById('recipesList');
            recipesList.innerHTML = '<div class="message">No more recipes found. Try a new search with different ingredients!</div>';
        }

        // Function to display recipes
        function displayRecipes(recipes) {
            try {
                const recipesList = document.getElementById('recipesList');
                if (!recipesList) {
                    throw new Error('Recipes list element not found');
                }

                recipesList.innerHTML = '';
                
                // Sort recipes by match percentage (100% matches first)
                const sortedRecipes = [...recipes].sort((a, b) => {
                    if (a.matchPercentage === 1 && b.matchPercentage !== 1) return -1;
                    if (a.matchPercentage !== 1 && b.matchPercentage === 1) return 1;
                    return b.matchPercentage - a.matchPercentage;
                });
                
                sortedRecipes.forEach(recipe => {
                    try {
                        const recipeCard = document.createElement('div');
                        recipeCard.className = 'recipe-card';
                        recipeCard.dataset.recipeId = recipe.id;
                        
                        // Create matched ingredients list
                        const matchedIngredientsList = recipe.matchedIngredients && recipe.matchedIngredients.length > 0
                            ? `<div class="matched-ingredients">
                                 <strong>Ingredients Match (${Math.round(recipe.matchPercentage * 100)}%):</strong>
                                 <ul>
                                   ${recipe.matchedIngredients.map(ing => `<li class="matched">âœ“ ${ing}</li>`).join('')}
                                   ${recipe.unmatchedIngredients.map(ing => `<li class="unmatched">âœ— ${ing}</li>`).join('')}
                                 </ul>
                               </div>`
                            : '';
                        
                        recipeCard.innerHTML = `
                            <div class="recipe-image">
                                <img src="${recipe.image || 'placeholder.jpg'}" alt="${recipe.title}" onerror="this.src='placeholder.jpg'">
                            </div>
                            <div class="recipe-content">
                                <h3>${recipe.title}</h3>
                                <p>Ready in ${recipe.readyInMinutes} minutes</p>
                                <div class="recipe-meta">
                                    <span>${recipe.difficulty || 'Medium'} difficulty</span>
                                </div>
                                <button onclick="window.location.href='displayRecipes.html?id=${recipe.id}'" class="view-recipe-btn">
                                    View Recipe
                                </button>
                            </div>
                        `;
                        
                        recipesList.appendChild(recipeCard);
                    } catch (error) {
                        console.error('Error creating recipe card:', error);
                    }
                });
            } catch (error) {
                console.error('Error in displayRecipes:', error);
                displayErrorMessage(error);
            }
        }

        // Function to display no ingredients message
        function displayNoIngredientsMessage() {
            const recipesList = document.getElementById('recipesList');
            if (recipesList) {
                recipesList.innerHTML = `
                    <div class="message">
                        <p>Please add some ingredients first!</p>
                        <p>Type an ingredient and click "Add" or press Enter.</p>
                    </div>
                `;
            }
        }

        // Function to display no recipes message
        function displayNoRecipesMessage() {
            const recipesList = document.getElementById('recipesList');
            if (recipesList) {
                recipesList.innerHTML = `
                    <div class="message">
                        <p>No recipes found with these ingredients.</p>
                        <p>Try adding more ingredients or different combinations!</p>
                    </div>
                `;
            }
        }

        // Function to display error message
        function displayErrorMessage(error) {
            console.error('Error:', error);
            const recipesList = document.getElementById('recipesList');
            if (recipesList) {
                recipesList.innerHTML = `
                    <div class="error-message">
                        <p>Something went wrong. Please try again later.</p>
                        <p class="error-details">${error.message || 'Unknown error'}</p>
                    </div>
                `;
            }
        }

        // Add event listener for Enter key
        document.getElementById('ingredientInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addIngredient();
            }
        });
    </script>
    <script src="script.js"></script>
    <script src="auth.js"></script>
    
    <style>
        /* AI Recipe Response Styling */
        .ai-recipe-response {
            background-color: #222;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            font-family: 'Poppins', sans-serif;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .ai-recipe-response h3 {
            color: #4caf50;
            margin-top: 25px;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        
        .ai-recipe-response h3:first-child {
            margin-top: 0;
        }
        
        .ai-recipe-response li {
            margin: 8px 0;
            line-height: 1.5;
            list-style-type: disc;
            margin-left: 20px;
        }
        
        .ai-recipe-response a {
            color: #4caf50;
            text-decoration: underline;
            transition: color 0.2s;
        }
        
        .ai-recipe-response a:hover {
            color: #6abf69;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .loading::before {
            content: "";
            width: 20px;
            height: 20px;
            border: 3px solid #444;
            border-top: 3px solid #4caf50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            text-align: center;
            padding: 20px;
            color: #aaa;
            font-style: italic;
        }
        
        .error-message {
            color: #ff6b6b;
            background-color: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</body>
</html>
